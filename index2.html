<!DOCTYPE html>
<html>
    <head>
        <title>What is the baby name?</title>
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-grid.min.css">
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap-reboot.min.css">
        <link rel="stylesheet" type="text/css" href="assets/theme/css/style.css">
        <style>
            .adjustable-div {
              width: 100%; /* Adjust as needed */
              height: auto; /* Adjust as needed */
              padding: 10px; /* Space inside the div */
              box-sizing: border-box; /* Includes padding and border in element's total width and height */
              overflow: clip; /* Add a scrollbar if necessary */
              white-space: pre-wrap;
            }
        </style>
    </head>
    <body>
        <pre><div id="chat" class="adjustable-div"></div></pre>
        <div id="input-area">
            <input id="input" type="text" />
            <button id="send">Send</button>
        </div>

        <script>
            var params = new URLSearchParams(window.location.search);
            var username = params.get("name");
            var language = params.get("language")
            var chatLogName = "chatLog" + username;

            const chat = document.getElementById('chat');
            const input = document.getElementById('input');
            const sendButton = document.getElementById('send');
            const chatLog = JSON.parse(localStorage.getItem(chatLogName)) || [];

            document.addEventListener('DOMContentLoaded', function() {
                Setup();
            }, false);

            function Setup() {
                if (chatLog.length == 0) {
                    const message = "My name is " + username + " I'll try to guess the baby's name in " + language;

                    sendMessage(message);
                }
            }

            function sendMessage(message) {
                appendMessage(message, 'user', true);

                fetch('https://baby-name-reveal-e392f1eb024a.herokuapp.com/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        conversations: chatLog
                    }),
                })
                .then((response) => response.json())
                .then((data) => {
                    const aiMessage = data.choices[0].message.content;
                    appendMessage(aiMessage, 'assistant', true);
                })
                .catch((error) => {
                    console.error('Error:', error);
                });
            }

            function appendMessage(content, role, saveMessage) {
                const messageElement = document.createElement('p');
                messageElement.textContent = `${role === 'user' ? 'You' : 'AI'}: ${content}`;
                chat.appendChild(messageElement);
                chat.scrollTop = chat.scrollHeight;

                if (saveMessage) {
                    // Save the message in the chat log and update localStorage
                    chatLog.push({ role, content });

                    if (chatLog.length > 10) {
                        chatLog.shift();
                    }

                    localStorage.setItem(chatLogName, JSON.stringify(chatLog));
                }
            }

            // Load the previous chat log from localStorage
            chatLog.forEach(({ content, role }) => {
                appendMessage(content, role, false);
            });

            sendButton.addEventListener('click', () => {
                const message = input.value;
                input.value = '';

                sendMessage(message);
            }
        )
        </script>
    </body>
</html>

